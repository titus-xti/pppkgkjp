{{define "index.html"}}
<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pemilihan Pendeta GKJ Pamulang</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>SURAT SUARA</h1>
      {{if .Name}}
        <div class="greeting">
          <h2>Selamat Datang,<br/>{{.Name}}</h2>
        </div>
      {{end}}
      {{if and (not .BeforeStart) (not .AfterEnd)}}
        <div class="notice" id="remainingBox" style="margin-top: 8px;">
          Pemilihan online akan berakhir dalam <br><span id="remaining" data-end="{{.EndISO}}" style="color: red; font-weight: bold;"></span>
        </div>
      {{end}}
    </header>

    <main>
      <div class="left">
        <div class="photo">
          <img src="/static/faisha.jpg" alt="Foto calon">
        </div>
        <div class="meta">
          <div class="calon">Calon Pendeta GKJ Pamulang</div>
          <div class="name">Pnt. Faisha Sudarlin, M.Th</div>
        </div>
      </div>

      <div class="right">
        <div class="topbox" style="text-align: center;">
          {{if .BeforeStart}}
            <div class="notice">Pemilihan online belum dimulai<br>Akan di mulai dalam : <br>
              <div id="countdown" data-start="{{.StartISO}}" data-end="{{.EndISO}}" style="color: red; font-weight: bold;"></div>
            </div>
          {{else if .AfterEnd}}
            <div class="notice">Pemilihan online telah ditutup pada <br/>{{.Day}} Jam {{.Time}}</div>
          {{else}}
            {{if .Name}}
              {{if .AlreadyUsed}}
                {{if .HasVoted}}
                <div class="thank-you-notice">
                  Terimakasih Atas Suara Anda
                </div>
                {{else}}
                <div class="used-code-notice">
                  Suara Anda sudah masuk,<br/>Terimakasih atas Partisipasi Anda<br>
                  <a href="/">Kembali</a>
                </div>
                {{end}}
              {{else}}
              <!-- Pemilihan online 
                <div class="question-box">
                  <div class="question">
                    <strong>Apakah anda SETUJU atau TIDAK SETUJU<br>Pnt. Faisha Sudarlin, M.Th<br>Sebagai Pendeta Kedua GKJ Pamulang?</strong>
                  </div>
                </div>
              -->
              {{end}}
            {{else}}
              <div id="code-entry" class="code-entry-container">
                <h3>Masukan Kode Unik</h3>
                <form id="codeForm" method="get" action="/" class="code-form">
                  <div class="form-group">
                    <input type="text" name="code" placeholder="Masukan kode unik Anda" required class="code-input">
                    <button type="submit" class="submit-button">Masuk</button>
                  </div>
                </form>
                <p style="color: red; margin-top: 10px;text-align: center; font-weight: bold;">{{ .Message }}</p>
              </div>
            {{end}}
          {{end}}
        </div>

        {{if and (not .BeforeStart) .Name (not .AlreadyUsed) (not .AfterEnd)}}
        <div class="choices" style="display: flex; justify-content: space-between; margin-top: 20px;">
          <div style="width: 100%;">
            <div style="display: flex; justify-content: space-around;">
              <div class="choiceBox big" data-choice="setuju" onclick="submitVote('setuju')" style="margin-right: 10px; cursor: pointer;">
                <input type="radio" id="setuju" name="choice" value="setuju" style="display: none;">
                <label for="setuju" class="choiceLabel">SETUJU</label>
              </div>
              <div class="choiceBox big" data-choice="tidak_setuju" onclick="submitVote('tidak_setuju')" style="margin-left: 10px; cursor: pointer;">
                <input type="radio" id="tdksetuju" name="choice" value="tidak_setuju" style="display: none;">
                <label for="tdksetuju" class="choiceLabel">TIDAK<br>SETUJU</label>
              </div>
            </div>
            {{if not .Code}}
            <p style="text-align: center; margin-top: 20px;">Masukkan kode dulu untuk memilih.</p>
            {{end}}
          </div>
        </div>
        {{end}}

      </div>
    </main>

    <footer>
      <p style="text-align: center; font-size: 16px; font-weight: bold;">Panitia Pemilihan Pendeta Kedua GKJ Pamulang</p>
    </footer>
  </div>

  <!-- Confirmation modal -->
  <div id="confirmModal" class="modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-content">
      <h3>Konfirmasi Suara</h3>
      <p>Suara yang sudah masuk tidak dapat di ubah, Anda yakin memilih <span id="modalChoice"></span>?</p>
      <div class="modal-buttons">
        <button id="confirmNo" class="btn-cancel">Batal</button>
        <button id="confirmYes" class="btn-confirm">Ya, Saya Yakin</button>
      </div>
    </div>
  </div>

  <style>
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .modal.show {
      opacity: 1;
    }
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 5px;
      text-align: center;
    }
    .modal-buttons {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    .btn-confirm, .btn-cancel {
      padding: 8px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    .btn-confirm {
      background-color: #4CAF50;
      color: white;
    }
    .btn-cancel {
      background-color: #f44336;
      color: white;
    }
  </style>
  <script>
  // Global variables
  var currentChoice = '';
  var modal, modalChoice, confirmYes, confirmNo;
  
  // Initialize everything when the page loads
  document.addEventListener('DOMContentLoaded', function() {
    // Get modal elements
    modal = document.getElementById('confirmModal');
    modalChoice = document.getElementById('modalChoice');
    confirmYes = document.getElementById('confirmYes');
    confirmNo = document.getElementById('confirmNo');
    
    // Set up event listeners
    setupModal();
    setupCountdown();
    setupRemaining();
  });
  
  // Set up modal event listeners
  function setupModal() {
    if (!modal) return;
    
    // Handle confirm button click
    if (confirmYes) {
      confirmYes.onclick = function() {
        if (!currentChoice) return;
        
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = '/vote';
        
        var urlParams = new URLSearchParams(window.location.search);
        var code = urlParams.get('code');
        
        var codeInput = document.createElement('input');
        codeInput.type = 'hidden';
        codeInput.name = 'code';
        codeInput.value = code || '';
        
        var choiceInput = document.createElement('input');
        choiceInput.type = 'hidden';
        choiceInput.name = 'choice';
        choiceInput.value = currentChoice;
        
        form.appendChild(codeInput);
        form.appendChild(choiceInput);
        document.body.appendChild(form);
        form.submit();
      };
    }

    // Handle cancel button click
    if (confirmNo) {
      confirmNo.onclick = closeModal;
    }

    // Close modal when clicking outside of it
    modal.onclick = function(event) {
      if (event.target === modal) {
        closeModal();
      }
    };
  }
  
  // Set up countdown timer
  function setupCountdown() {
    var cd = document.getElementById('countdown');
    if (!cd) return;
    
    var start = new Date(cd.dataset.start);
    var end = new Date(cd.dataset.end);
    
    function updateCountdown() {
      var now = new Date();
      if (now > end) {
        cd.innerText = "Pemilihan ditutup.";
        return;
      }
      var diff = start - now;
      if (diff <= 0) {
        cd.innerText = "Pemilihan sudah dibuka. Silakan muat ulang halaman.";
        location.reload();
        return;
      }
      var days = Math.floor(diff / (1000*60*60*24));
      var hrs = Math.floor((diff % (1000*60*60*24)) / (1000*60*60));
      var min = Math.floor((diff % (1000*60*60)) / (1000*60));
      var sec = Math.floor((diff % (1000*60)) / 1000);
      cd.innerText =  days + " hari " + hrs + " jam " + min + "menit " + sec + " detik";
    }
    
    updateCountdown();
    setInterval(updateCountdown, 1000);
  }
  
  // Set up remaining time (active period) countdown
  function setupRemaining() {
    var el = document.getElementById('remaining');
    if (!el) return;

    var end = new Date(el.dataset.end);

    function updateRemaining() {
      var now = new Date();
      var diff = end - now;
      if (diff <= 0) {
        el.innerText = '0 Jam 0 menit 0 detik';
        return;
      }
      var hours = Math.floor(diff / (1000*60*60));
      var minutes = Math.floor((diff % (1000*60*60)) / (1000*60));
      var seconds = Math.floor((diff % (1000*60)) / 1000);
      el.innerText = hours + ' Jam ' + minutes + ' menit ' + (seconds < 10 ? '0' + seconds : seconds) + ' detik';
    }

    updateRemaining();
    setInterval(updateRemaining, 1000);
  }
  
  // Function to close the modal
  function closeModal() {
    if (modal) {
      modal.style.display = 'none';
      document.body.classList.remove('modal-open');
      modal.classList.remove('show');
      
      // Re-enable scrolling
      document.body.style.overflow = 'auto';
      
      // Remove the escape key listener
      document.removeEventListener('keydown', handleEscapeKey);
    }
  }
  
  // Function to show the modal
  function showModal() {
    if (modal) {
      // Disable scrolling on the body
      document.body.style.overflow = 'hidden';
      document.body.classList.add('modal-open');
      
      // Show the modal
      modal.style.display = 'flex';
      
      // Force reflow to enable transition
      void modal.offsetWidth;
      
      // Add show class for transition
      modal.classList.add('show');
      
      // Add escape key listener
      document.addEventListener('keydown', handleEscapeKey);
    }
  }
  
  // Handle escape key press
  function handleEscapeKey(event) {
    if (event.key === 'Escape') {
      closeModal();
    }
  }
  
  // Global function to show the modal when voting
  window.submitVote = function(choice) {
    console.log('submitVote called with choice:', choice);
    
    var urlParams = new URLSearchParams(window.location.search);
    var code = urlParams.get('code');
    
    if (!code) {
      alert("Silakan masukan kode terlebih dahulu.");
      return;
    }
    
    currentChoice = choice;
    if (modalChoice) {
      modalChoice.textContent = choice === 'setuju' ? 'SETUJU' : 'TIDAK SETUJU';
    }
    
    showModal();
  };
  
  function initializeModal() {
    modal = document.getElementById('confirmModal');
    if (modal) {
      modalChoice = document.getElementById('modalChoice');
      confirmYes = document.getElementById('confirmYes');
      confirmNo = document.getElementById('confirmNo');
      
      // Handle confirm button click
      if (confirmYes) {
        confirmYes.addEventListener('click', function() {
          if (!currentChoice) return;
          
          var form = document.createElement('form');
          form.method = 'POST';
          form.action = '/vote';
          
          var urlParams = new URLSearchParams(window.location.search);
          var code = urlParams.get('code');
          
          var codeInput = document.createElement('input');
          codeInput.type = 'hidden';
          codeInput.name = 'code';
          codeInput.value = code || '';
          
          var choiceInput = document.createElement('input');
          choiceInput.type = 'hidden';
          choiceInput.name = 'choice';
          choiceInput.value = currentChoice;
          
          form.appendChild(codeInput);
          form.appendChild(choiceInput);
          document.body.appendChild(form);
          form.submit();
        });
      }

      // Handle cancel button click
      if (confirmNo) {
        confirmNo.addEventListener('click', function() {
          closeModal();
        });
      }

      // Close modal when clicking outside of it
      modal.addEventListener('click', function(event) {
        if (event.target === modal) {
          closeModal();
        }
      });
      
      // Function to close the modal
      function closeModal() {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto'; // Re-enable scrolling
      }
    }
  }
  
  // Global function to show the modal
  window.submitVote = function(choice) {
    console.log('submitVote called with choice:', choice);
    
    var urlParams = new URLSearchParams(window.location.search);
    var code = urlParams.get('code');
    
    if (!code) {
      console.log('No code found in URL');
      alert("Silakan masukan kode terlebih dahulu.");
      return;
    }
    
    currentChoice = choice;
    if (modalChoice) {
      modalChoice.textContent = choice === 'setuju' ? 'SETUJU' : 'TIDAK SETUJU';
    }
    
    // Show the modal
    console.log('Showing modal');
    showModal();
  };

  function getCodeFromUrl() {
    // Check URL path first (e.g., /Ht67h)
    var pathCode = window.location.pathname.substring(1).trim();
    if (pathCode && pathCode !== '/') {
      return pathCode;
    }
    
    // Check query parameter (e.g., ?code=Ht67h)
    var params = new URLSearchParams(window.location.search);
    var queryCode = params.get('code');
    if (queryCode && queryCode.trim() !== '') {
      return queryCode.trim();
    }
    
    return null;
  }

  document.addEventListener('DOMContentLoaded', function() {
    var code = getCodeFromUrl();
    var codeForm = document.getElementById('codeForm');
    var greeting = document.getElementById('greeting');
    
    if (code && codeForm && greeting) {
      // If we have a code in URL, hide the form and submit it automatically
      codeForm.style.display = 'none';
      greeting.innerHTML = '<p>Memeriksa kode...</p>';
      
      // Set the code in the form and submit it
      var codeInput = codeForm.querySelector('input[name="code"]');
      if (codeInput) {
        codeInput.value = code;
      }
      codeForm.submit();
      return;
    }
    
    // Initialize modal if we get here
    initializeModal();
    
    // countdown logic
    var cd = document.getElementById('countdown');
    if (cd) {
      var start = new Date(cd.dataset.start);
      var end = new Date(cd.dataset.end);
      
      function updateCountdown() {
        var now = new Date();
        if (now > end) {
          cd.innerText = "Pemilihan ditutup.";
          return;
        }
        var diff = start - now;
        if (diff <= 0) {
          cd.innerText = "Pemilihan sudah dibuka. Silakan muat ulang halaman.";
          location.reload();
          return;
        }
        var days = Math.floor(diff / (1000*60*60*24));
        var hrs = Math.floor((diff % (1000*60*60*24)) / (1000*60*60));
        var min = Math.floor((diff % (1000*60*60)) / (1000*60));
        var sec = Math.floor((diff % (1000*60)) / 1000);
        cd.innerText =  days + " hari " + hrs + " jam " + min + " menit " + sec + " detik";
      }
      
      updateCountdown();
      setInterval(updateCountdown, 1000);
    }

    // If success param present in URL, show a message
    var params = new URLSearchParams(location.search);
    if (params.get('success') === '1') {
      alert("Suara Anda telah tercatat. Terima kasih.");
    }
  });
</script>
</body>
</html>
{{end}}
